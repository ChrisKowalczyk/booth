# vim: ft=sh et :
#
# Testing whether the external verifier (before-acquire-handler)
# is obeyed.


ticket:
    name                "tick1"
    state               ST_STABLE
    last_ack_ballot     40
    new_ballot          50
    owner               local
    retries             6
    timeout             1
    # may keep ticket all the time
    expiry              3000
    # but shall start renewal now
    expires             time(0) + 1000
    ext_verifier        "test `set|grep ^BOOTH|wc -l` -ge 5"



outgoing0:
    header.cmd          OP_PREPARING


ticket1:
    ext_verifier        'test "$BOOTH_TICKET" == "tick1"'
    # cause re-query of the verifier
    state               ST_STABLE

#
#gdb1:
#    break ticket_broadcast_proposed_state ยง commands ยง bt ยง c ยง end


outgoing1:
    header.cmd          OP_PREPARING


# now say that we may not have it anymore.
ticket2:
    ext_verifier        'test "$BOOTH_TICKET" == "tick2FOO"'
    # cause re-query of the verifier
    state               ST_STABLE

# We just tell the others we don't have it anymore.
outgoing2:
    header.cmd          OP_COMMITTED
    ticket.owner        -1

finally:
    state        ST_STABLE
    owner        NULL
